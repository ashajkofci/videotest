name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-app:
    name: Build .app
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app || sudo xcode-select -s /Applications/Xcode.app

      - name: Build release binary (universal)
        run: swift build -c release -v --arch arm64 --arch x86_64

      - name: Compile Metal shaders
        run: |
          xcrun metal -c Sources/VJApp/Resources/Shaders.metal -o /tmp/Shaders.air
          xcrun metallib /tmp/Shaders.air -o /tmp/default.metallib

      - name: Create .app bundle
        run: |
          APP_NAME="VJApp"
          APP_DIR="${APP_NAME}.app/Contents"
          mkdir -p "${APP_DIR}/MacOS"
          mkdir -p "${APP_DIR}/Resources"

          BUILD_DIR=".build/apple/Products/Release"

          # Copy executable
          cp "${BUILD_DIR}/${APP_NAME}" "${APP_DIR}/MacOS/${APP_NAME}"

          # Copy compiled Metal library
          cp /tmp/default.metallib "${APP_DIR}/Resources/default.metallib"

          # Copy bundle resources
          for bundle in "${BUILD_DIR}"/*.bundle; do
            if [ -d "$bundle" ]; then
              cp -R "$bundle" "${APP_DIR}/Resources/"
            fi
          done

          # Create Info.plist
          VERSION="${GITHUB_REF_NAME:-0.1.0}"
          VERSION="${VERSION#v}"
          cat > "${APP_DIR}/Info.plist" << 'PLISTEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>VJApp</string>
              <key>CFBundleIdentifier</key>
              <string>com.vjapp.app</string>
              <key>CFBundleName</key>
              <string>VJApp</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
          PLISTEOF

          # Append version dynamically
          echo "    <string>${VERSION}</string>" >> "${APP_DIR}/Info.plist"
          cat >> "${APP_DIR}/Info.plist" << 'PLISTEOF'
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLISTEOF

      - name: Ad-hoc sign app bundle
        run: codesign --force --deep --sign - "VJApp.app"

      - name: Create zip archive
        run: |
          zip -r VJApp.zip VJApp.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VJApp
          path: VJApp.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: VJApp.zip
          generate_release_notes: true
